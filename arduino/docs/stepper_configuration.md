# Конфигурация шаговых двигателей

## Обзор

Система поддерживает индивидуальные настройки для каждого шагового двигателя. Все настройки находятся в файле `include/config.h` и позволяют точно настроить поведение каждого двигателя под конкретные требования.

## Настраиваемые параметры

Для каждого двигателя доступны следующие параметры:

### 1. Шаги на оборот (STEPS_PER_REVOLUTION)
- **Описание**: Количество шагов для полного оборота двигателя
- **Типичные значения**: 
  - 200 (1.8° на шаг)
  - 400 (0.9° на шаг) 
  - Другие значения в зависимости от драйвера и микрошагов

### 2. Максимальная скорость (MAX_SPEED)
- **Описание**: Максимальная скорость движения в шагах/секунду
- **Единицы**: steps/sec
- **Рекомендации**: Учитывайте нагрузку и момент двигателя

### 3. Ускорение (ACCELERATION)
- **Описание**: Ускорение при разгоне и торможении
- **Единицы**: steps/sec²
- **Рекомендации**: Более высокие значения для быстрого позиционирования, более низкие для плавного движения

### 4. Скорость хоминга (HOMING_SPEED)
- **Описание**: Скорость движения при процедуре хоминга
- **Единицы**: steps/sec
- **Рекомендации**: Должна быть ниже максимальной скорости для точности

### 5. Тип датчика концевого выключателя (ENDSTOP_TYPE_NPN)
- **Описание**: Тип логики концевого выключателя
- **Значения**:
  - `true` - NPN (активное состояние = LOW)
  - `false` - PNP (активное состояние = HIGH)

### 6. Постоянное питание (POWER_ALWAYS_ON)
- **Описание**: Режим питания двигателя
- **Значения**:
  - `true` - Постоянное питание (двигатель всегда активен)
  - `false` - Временное питание (включается только при движении)
- **Рекомендации**: 
  - Постоянное питание для точного позиционирования
  - Временное питание для экономии энергии и уменьшения нагрева

#### Особенности режимов питания:

**Постоянное питание (`true`):**
- ✅ Удержание позиции в простое
- ✅ Быстрая готовность к движению
- ❌ Постоянное потребление энергии
- ❌ Нагрев двигателя в простое

**Временное питание (`false`):**
- ✅ Экономия энергии в простое  
- ✅ Отсутствие нагрева в простое
- ❌ Возможная потеря позиции в простое
- ❌ Небольшая задержка включения перед движением

## Текущая конфигурация

### Multi (X) - Основной двигатель
```cpp
#define MULTI_STEPS_PER_REVOLUTION 200
#define MULTI_MAX_SPEED 800
#define MULTI_ACCELERATION 1000
#define MULTI_HOMING_SPEED 300
#define MULTI_ENDSTOP_TYPE_NPN true
```

### Multizone (Y) - Зонный двигатель
```cpp
#define MULTIZONE_STEPS_PER_REVOLUTION 200
#define MULTIZONE_MAX_SPEED 600
#define MULTIZONE_ACCELERATION 800
#define MULTIZONE_HOMING_SPEED 250
#define MULTIZONE_ENDSTOP_TYPE_NPN true
```

### RRight (Z) - Правый двигатель
```cpp
#define RRIGHT_STEPS_PER_REVOLUTION 200
#define RRIGHT_MAX_SPEED 500
#define RRIGHT_ACCELERATION 600
#define RRIGHT_HOMING_SPEED 200
#define RRIGHT_ENDSTOP_TYPE_NPN true
```

### E0 - Экструдер 0
```cpp
#define E0_STEPS_PER_REVOLUTION 200
#define E0_MAX_SPEED 2000
#define E0_ACCELERATION 2000
#define E0_HOMING_SPEED 1000
#define E0_ENDSTOP_TYPE_NPN true
#define E0_POWER_ALWAYS_ON true
```

### E1 - Экструдер 1
```cpp
#define E1_STEPS_PER_REVOLUTION 200
#define E1_MAX_SPEED 2000
#define E1_ACCELERATION 2000
#define E1_HOMING_SPEED 1000
#define E1_ENDSTOP_TYPE_NPN true
#define E1_POWER_ALWAYS_ON true
```

## Настройка датчиков

### NPN датчики
- **Принцип работы**: Замыкают на землю при срабатывании
- **Логика**: Сработал = LOW (0), не сработал = HIGH (1)
- **Подключение**: Требуют подтяжки к питанию (INPUT_PULLUP)

### PNP датчики
- **Принцип работы**: Подают питание при срабатывании
- **Логика**: Сработал = HIGH (1), не сработал = LOW (0)
- **Подключение**: Требуют подтяжки к земле

## Рекомендации по настройке

### 1. Определение шагов на оборот
```
Шаги на оборот = Базовые шаги × Микрошаги
Например: 200 × 16 = 3200 (для 16 микрошагов)
```

### 2. Подбор скорости
- Начните с консервативных значений
- Постепенно увеличивайте до появления пропусков шагов
- Уменьшите на 20-30% от максимального значения

### 3. Настройка ускорения
- Высокие значения = быстрое позиционирование
- Низкие значения = плавное движение
- Учитывайте инерцию нагрузки

### 4. Выбор скорости хоминга
- Должна быть достаточно низкой для точного срабатывания концевика
- Обычно 30-50% от максимальной скорости

## Типичные проблемы и решения

### Пропуск шагов
- **Причина**: Слишком высокая скорость или ускорение
- **Решение**: Уменьшите MAX_SPEED и/или ACCELERATION

### Неточное позиционирование
- **Причина**: Неправильное количество шагов на оборот
- **Решение**: Проверьте настройки драйвера и STEPS_PER_REVOLUTION

### Ошибки хоминга
- **Причина**: Неправильный тип датчика или слишком высокая скорость
- **Решение**: Проверьте ENDSTOP_TYPE_NPN и уменьшите HOMING_SPEED

### Медленное движение
- **Причина**: Слишком низкое ускорение
- **Решение**: Увеличьте ACCELERATION

## Изменение настроек

1. Откройте файл `include/config.h`
2. Найдите секцию нужного двигателя
3. Измените требуемые параметры
4. Сохраните файл и перекомпилируйте проект

## Тестирование

После изменения настроек рекомендуется:

1. Протестировать команду `test` для проверки связи
2. Выполнить хоминг: `zero_multi`, `zero_multizone`, `zero_rright`
3. Проверить движение: `move_multi 1000`, `move_multizone 500`, etc.
4. Протестировать функции clamp: `clamp_zero`, `clamp 500`

## Диагностика

Для диагностики используйте команды:
- `check_all_endstops` - проверка всех концевых выключателей
- `check_multi_endstop` - проверка конкретного концевика
- Команды движения с небольшими значениями для проверки направления

## Бэкап настроек

Рекомендуется сохранять рабочие конфигурации перед внесением изменений:

```cpp
// Рабочая конфигурация Multi от [дата]
// MAX_SPEED: 800, ACCELERATION: 1000, работает стабильно
``` 