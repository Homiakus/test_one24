# Тесты и проверки качества

## Критерии приёмки (Definition of Done)

### Функциональные критерии
- [ ] **REQ-001**: Система может анализировать структуру проекта
- [ ] **REQ-002**: Система может оценивать качество кода
- [ ] **REQ-003**: Система может выявлять риски безопасности
- [ ] **REQ-004**: Система может генерировать отчёты
- [ ] **REQ-005**: Система может отслеживать прогресс исправлений

### Качественные критерии
- [ ] **QUAL-001**: Покрытие тестами критичных модулей ≥90%
- [ ] **QUAL-002**: Покрытие тестами остальных модулей ≥80%
- [ ] **QUAL-003**: Количество предупреждений mypy = 0
- [ ] **QUAL-004**: Количество критических уязвимостей SAST = 0
- [ ] **QUAL-005**: Время выполнения тестов < 5 минут

### Безопасность
- [ ] **SEC-001**: Соответствие OWASP Top 10
- [ ] **SEC-002**: Отсутствие секретов в коде
- [ ] **SEC-003**: Валидация всех входных данных
- [ ] **SEC-004**: Аудит всех операций

### Производительность
- [ ] **PERF-001**: Время анализа проекта < 30 секунд
- [ ] **PERF-002**: Использование памяти < 500MB
- [ ] **PERF-003**: Время генерации отчёта < 10 секунд

## Тестовые сценарии

### 1. Анализ структуры проекта

#### TC-001: Анализ основных модулей
**Цель**: Проверить способность системы анализировать структуру проекта

**Предусловия**:
- Проект содержит модули core, ui, monitoring, arduino
- Конфигурационные файлы присутствуют

**Шаги**:
1. Запустить анализ структуры проекта
2. Проверить обнаружение основных модулей
3. Проверить анализ зависимостей

**Ожидаемый результат**:
- Все основные модули обнаружены
- Зависимости проанализированы
- Структура задокументирована

**Критерии успеха**:
- ✅ Обнаружены модули: core, ui, monitoring, arduino
- ✅ Проанализированы файлы: requirements.txt, pyproject.toml
- ✅ Создан отчёт о структуре

#### TC-002: Анализ конфигурационных файлов
**Цель**: Проверить анализ конфигурационных файлов

**Предусловия**:
- Присутствуют config.toml, pyproject.toml, requirements.txt

**Шаги**:
1. Запустить анализ конфигурации
2. Проверить валидацию TOML файлов
3. Проверить анализ зависимостей

**Ожидаемый результат**:
- Конфигурационные файлы валидны
- Зависимости проанализированы
- Потенциальные проблемы выявлены

### 2. Анализ качества кода

#### TC-003: Проверка типов mypy
**Цель**: Проверить статический анализ типов

**Предусловия**:
- Установлен mypy
- Код содержит type hints

**Шаги**:
1. Запустить mypy на всех Python файлах
2. Проанализировать результаты
3. Создать отчёт о проблемах

**Ожидаемый результат**:
- Все type hints корректны
- Нет ошибок типизации
- Отчёт о качестве типов создан

#### TC-004: Анализ покрытия тестами
**Цель**: Проверить покрытие кода тестами

**Предусловия**:
- Присутствуют тестовые файлы
- Установлен pytest и coverage

**Шаги**:
1. Запустить тесты с coverage
2. Проанализировать покрытие по модулям
3. Выявить непокрытые участки

**Ожидаемый результат**:
- Покрытие критичных модулей ≥90%
- Покрытие остальных модулей ≥80%
- Отчёт о покрытии создан

### 3. Анализ безопасности

#### TC-005: SAST анализ
**Цель**: Проверить статический анализ безопасности

**Предусловия**:
- Установлен semgrep или аналогичный инструмент
- Настроены правила безопасности

**Шаги**:
1. Запустить SAST сканирование
2. Проанализировать найденные уязвимости
3. Оценить критичность проблем

**Ожидаемый результат**:
- Критические уязвимости отсутствуют
- Средние уязвимости задокументированы
- План исправления создан

#### TC-006: Поиск секретов в коде
**Цель**: Проверить отсутствие секретов в коде

**Предусловия**:
- Настроен детектор секретов (gitleaks, truffleHog)

**Шаги**:
1. Запустить сканирование на секреты
2. Проверить результаты
3. Убедиться в отсутствии секретов

**Ожидаемый результат**:
- Секреты в коде отсутствуют
- Все чувствительные данные в vault/KMS
- Отчёт о безопасности создан

### 4. Генерация отчётов

#### TC-007: Создание отчёта о качестве
**Цель**: Проверить генерацию отчётов

**Предусловия**:
- Проведён анализ структуры и качества

**Шаги**:
1. Сгенерировать отчёт о качестве
2. Проверить полноту информации
3. Проверить формат отчёта

**Ожидаемый результат**:
- Отчёт содержит все необходимые разделы
- Метрики корректно рассчитаны
- Рекомендации предоставлены

#### TC-008: Создание отчёта о рисках
**Цель**: Проверить анализ рисков

**Предусловия**:
- Выявлены потенциальные риски

**Шаги**:
1. Создать карту рисков
2. Оценить вероятность и влияние
3. Предложить стратегии митигации

**Ожидаемый результат**:
- Риски классифицированы по приоритету
- Стратегии митигации определены
- План действий создан

## Негативные сценарии

### TC-009: Обработка некорректной конфигурации
**Цель**: Проверить обработку ошибок

**Шаги**:
1. Предоставить некорректный config.toml
2. Запустить анализ
3. Проверить обработку ошибки

**Ожидаемый результат**:
- Ошибка корректно обработана
- Информативное сообщение об ошибке
- Система не падает

### TC-010: Обработка отсутствующих файлов
**Цель**: Проверить graceful degradation

**Шаги**:
1. Удалить критичные файлы
2. Запустить анализ
3. Проверить поведение системы

**Ожидаемый результат**:
- Система продолжает работать
- Отсутствующие файлы задокументированы
- Предупреждения выданы

## Автоматизированные тесты

### Unit тесты
```python
def test_project_structure_analysis():
    """Тест анализа структуры проекта"""
    analyzer = ProjectStructureAnalyzer()
    result = analyzer.analyze(".")
    assert result.modules == ["core", "ui", "monitoring", "arduino"]
    assert result.has_config_files

def test_code_quality_analysis():
    """Тест анализа качества кода"""
    analyzer = CodeQualityAnalyzer()
    result = analyzer.analyze(".")
    assert result.mypy_errors == 0
    assert result.test_coverage >= 80

def test_security_analysis():
    """Тест анализа безопасности"""
    analyzer = SecurityAnalyzer()
    result = analyzer.analyze(".")
    assert result.critical_vulnerabilities == 0
    assert not result.has_secrets
```

### Integration тесты
```python
def test_full_analysis_pipeline():
    """Тест полного пайплайна анализа"""
    pipeline = AnalysisPipeline()
    result = pipeline.run(".")
    assert result.structure_analyzed
    assert result.quality_analyzed
    assert result.security_analyzed
    assert result.report_generated
```

## Метрики качества

### Количественные метрики
- **Покрытие тестами**: ≥80% (критичные ≥90%)
- **Время выполнения тестов**: < 5 минут
- **Количество предупреждений**: 0 критических
- **Количество уязвимостей**: 0 критических

### Качественные метрики
- **Читаемость кода**: Соответствие PEP 8
- **Документированность**: Все публичные API документированы
- **Производительность**: Приемлемое время выполнения
- **Безопасность**: Соответствие стандартам безопасности

## Критерии готовности к продакшену

### Обязательные критерии
- [ ] Все функциональные тесты проходят
- [ ] Покрытие тестами ≥80%
- [ ] Нет критических уязвимостей
- [ ] Производительность соответствует требованиям
- [ ] Документация актуальна

### Рекомендуемые критерии
- [ ] Покрытие тестами ≥90%
- [ ] Автоматизированные тесты в CI/CD
- [ ] Мониторинг производительности
- [ ] План disaster recovery
- [ ] Обучение команды