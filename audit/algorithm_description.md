# Текстовое описание алгоритма работы приложения PyQt6 Device Control

## Общий алгоритм программы

Приложение PyQt6 Device Control представляет собой десктопное приложение для управления устройством через последовательный порт. Алгоритм работы состоит из следующих основных этапов:

### 1. Инициализация и запуск
Приложение запускается через `main.py`, где происходит:
- Проверка критических зависимостей (PyQt6, qt_material)
- Настройка логирования с обработкой ошибок
- Создание QApplication с именем и версией
- Применение темы интерфейса (Material Design или fallback на Fusion)

### 2. Создание главного окна
Создается главное окно `MainWindow`, которое выполняет:
- Инициализацию всех сервисов напрямую (SerialManager, SequenceManager, TagManager, MultizoneManager)
- Загрузку конфигурации из файлов (settings.json, config.toml)
- Настройку UI с несколькими страницами (Commands, Sequences, Designer, Firmware, Flags, Signals, Settings, Wizard)
- Установку соединений между компонентами через сигналы Qt

### 3. Автоподключение к устройству
Если включено автоподключение в настройках:
- Происходит попытка подключения к устройству через 2 секунды после запуска
- SerialManager открывает COM-порт с заданными параметрами
- Создаются потоки для чтения и записи данных
- Устанавливается статус подключения

### 4. Главный цикл работы
Запускается главный цикл приложения с:
- Периодической проверкой состояния подключения каждые 5 секунд
- Обработкой действий пользователя через UI
- Выполнением команд и последовательностей
- Управлением тегами и зонами устройства

### 5. Обработка команд пользователя
Пользователь может выполнять следующие действия:
- **Отправка одиночных команд**: через SerialManager.send_command()
- **Выполнение последовательностей**: через SequenceManager.execute_sequence()
- **Управление тегами**: создание и получение команд по тегам
- **Мультизональное управление**: отправка команд в несколько зон одновременно

### 6. Graceful shutdown
При завершении работы происходит:
- Закрытие соединения с устройством
- Сохранение настроек в файлы
- Корректное завершение всех потоков
- Освобождение ресурсов

## Детальный алгоритм основных функций

### SerialManager.connect()
1. Валидация параметров подключения (порт, скорость, таймаут)
2. Создание объекта serial.Serial с заданными параметрами
3. Открытие порта с обработкой исключений
4. Создание потоков для чтения и записи данных
5. Установка обработчиков сигналов для graceful shutdown
6. Запуск потоков и ожидание готовности
7. Возврат статуса подключения

### SequenceManager.execute_sequence()
1. Валидация последовательности команд
2. Создание токена отмены для возможности прерывания
3. Последовательное выполнение команд с проверкой условий
4. Обработка команд ожидания и условных команд
5. Логирование результатов выполнения
6. Возврат статуса выполнения последовательности

### TagManager.create_tag()
1. Валидация имени тега и связанных команд
2. Проверка уникальности имени тега
3. Создание объекта тега с метаданными
4. Сохранение тега в памяти
5. Обновление UI для отображения нового тега
6. Возврат созданного тега

## Потоки данных

### Основные данные приложения:
- **serial_settings**: настройки COM-порта (JSON файл)
- **update_settings**: настройки обновления и автоподключения (JSON файл)
- **config**: основная конфигурация приложения (TOML файл)
- **flags**: глобальные флаги для условного выполнения (в памяти)
- **sequences**: загруженные последовательности команд (в памяти)
- **tags**: система тегов для организации команд (в памяти)
- **connection_status**: статус подключения к устройству (в памяти)
- **monitoring_data**: данные мониторинга состояния (в памяти)

### Обработка команд:
1. Пользователь вводит команду через UI
2. Команда валидируется и форматируется
3. Отправляется через SerialManager к устройству
4. Устройство обрабатывает команду и возвращает ответ
5. Ответ парсится и отображается в UI
6. Команда и результат сохраняются в истории

### Обработка последовательностей:
1. Загружается последовательность команд из конфигурации
2. Каждая команда в последовательности валидируется
3. Последовательно выполняются команды с проверкой условий
4. Результаты каждой команды логируются
5. При ошибке последовательность может быть прервана
6. Финальный результат отображается пользователю

## Система мониторинга

Приложение включает систему мониторинга, которая:
- Отслеживает состояние подключения к устройству
- Мониторит производительность выполнения команд
- Логирует ошибки и предупреждения
- Предоставляет метрики использования ресурсов
- Позволяет настройку уровней логирования

## Обработка ошибок

Система включает многоуровневую обработку ошибок:
1. **Валидация входных данных** на уровне UI
2. **Проверка состояния подключения** перед отправкой команд
3. **Обработка исключений** при работе с последовательным портом
4. **Graceful degradation** при недоступности компонентов
5. **Логирование ошибок** для отладки
6. **Информативные сообщения** для пользователя

## Архитектурные особенности

- **Многослойная архитектура**: UI, Business Logic, Communication, Data
- **Dependency Injection**: для управления зависимостями между компонентами
- **Event-driven**: использование сигналов Qt для связи компонентов
- **Multithreading**: асинхронная обработка команд и мониторинг
- **Configuration-driven**: настройка через внешние файлы
- **Extensible**: модульная структура для добавления новых функций
