# Система тегов команд - План реализации

## Этап 1: Инфраструктура тегов

### 1.1 Создание типов данных
- `core/tag_types.py` - типы данных для тегов
- `TagType` enum - типы тегов
- `TagInfo` dataclass - информация о теге
- `TagResult` dataclass - результат обработки тега

### 1.2 Создание интерфейсов
- `core/interfaces.py` - расширение интерфейсов
- `ITagManager` - интерфейс менеджера тегов
- `ITagProcessor` - интерфейс обработчика тегов

### 1.3 Создание базовых компонентов
- `core/tag_manager.py` - менеджер тегов
- `core/tag_validator.py` - валидатор тегов
- `core/tag_processor.py` - процессор тегов

## Этап 2: Реализация тега `_wanted`

### 2.1 Создание UI компонентов
- `ui/dialogs/tag_dialogs.py` - диалоги для тегов
- `WantedTagDialog` - диалог для тега `_wanted`

### 2.2 Реализация логики тега
- `core/tags/wanted_tag.py` - реализация тега `_wanted`
- Логика проверки переменной `wanted`
- Интеграция с UI диалогом

### 2.3 Интеграция с системой переменных
- Расширение `FlagManager` для поддержки переменных
- Добавление переменной `wanted`

## Этап 3: Интеграция с командной системой

### 3.1 Расширение CommandValidator
- Поддержка парсинга тегов
- Валидация тегов в командах

### 3.2 Расширение CommandExecutor
- Интеграция обработки тегов
- Поддержка мультизональных команд с тегами

### 3.3 Расширение MultizoneManager
- Поддержка тегов в мультизональных командах

## Этап 4: UI интеграция

### 4.1 Интеграция с MainWindow
- Подключение диалогов тегов
- Обработка результатов тегов

### 4.2 Интеграция с WizardPage
- Поддержка тегов в мастере
- UI для отображения состояния тегов

## Этап 5: Тестирование и документация

### 5.1 Создание тестов
- Unit тесты для всех компонентов
- Integration тесты
- UI тесты для диалогов

### 5.2 Обновление документации
- Обновление changelog.md
- Обновление tasktracker.md
- Создание руководства пользователя

## Детали реализации

### Структура команды с тегами
```
og_multizone-test_wanted_other
│        │    │
│        │    └── теги (_wanted, _other)
│        └── базовая команда (test)
└── префикс мультизональной команды
```

### Алгоритм обработки
1. Парсинг команды и извлечение тегов
2. Валидация тегов
3. Обработка тегов в порядке появления
4. Выполнение базовой команды (если все теги пройдены)

### Обработка тега `_wanted`
1. Проверка переменной `wanted`
2. Если `wanted = true`:
   - Показать диалог "закончилась жидкость"
   - Ждать подтверждения пользователя
   - После подтверждения продолжить выполнение
3. Если `wanted = false`:
   - Продолжить выполнение команды

## Файлы для создания/изменения

### Новые файлы
- `core/tag_types.py`
- `core/tag_manager.py`
- `core/tag_validator.py`
- `core/tag_processor.py`
- `core/tags/wanted_tag.py`
- `ui/dialogs/tag_dialogs.py`
- `tests/unit/test_tag_system.py`
- `tests/integration/test_tag_integration.py`

### Изменяемые файлы
- `core/interfaces.py` - добавление интерфейсов
- `core/command_validator.py` - поддержка тегов
- `core/command_executor.py` - интеграция тегов
- `core/multizone_manager.py` - поддержка тегов
- `ui/main_window.py` - интеграция диалогов
- `ui/pages/wizard_page.py` - поддержка тегов
- `docs/changelog.md` - обновление документации
- `docs/tasktracker.md` - обновление трекера задач
