# Система управления аппаратом окраски

Веб-приложение на Flask для управления автоматизированным аппаратом окраски микробиологических препаратов.

## Особенности

- Управление 4 независимыми зонами окраски
- Контроль состояния сливной емкости
- Мониторинг датчиков пробирок и предметных стекол
- Поддержка различных комбинаций зон окраски
- Режим эмуляции для тестирования без реального оборудования

## Установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd <repository-directory>
```

2. Создайте виртуальное окружение и установите зависимости:
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows
pip install -r requirements.txt
```

## Запуск

### Обычный режим
Требует подключения к аппарату через COM-порт:
```bash
python run.py
```

### Режим эмуляции
Для тестирования без реального оборудования:
```bash
python run.py --emulation
```

После запуска приложение будет доступно по адресу: http://localhost:5000

## Требования

- Python 3.8+
- Flask
- pyserial (для работы с COM-портом)
- Порт COM для подключения аппарата (в режиме эмуляции не требуется)

## настройки toml

### Команды для первого ротора (moveL)
поворот 1 ротора в налив og  - moveL_2
поворот 1 ротора в налив ea  - moveL_3
поворот 1 ротора в налив gemo - moveL_4
поворот 1 ротора в налив alco - moveL_10
поворот 1 ротора в налив water  - moveL_1
поворот 1 ротора в налив chlor - moveL_12
поворот 1 ротора в слив - moveL_90
поворот 1 ротора в экспозицию - moveL_180
поворот 1 ротора в загрузку пробирок - moveL_40
поворот 1 ротора в извлечени пробирок - moveL_60
поворот 1 ротора в установку стекол - moveL_180
поворот 1 ротора в извлесение стекол - moveL_180

### Команды для второго ротора (moveR)
поворот 2 ротора в налив og  - moveR_2
поворот 2 ротора в налив ea  - moveR_3
поворот 2 ротора в налив gemo - moveR_4
поворот 2 ротора в налив alco - moveR_10
поворот 2 ротора в налив water  - moveR_1
поворот 2 ротора в налив chlor - moveR_12
поворот 2 ротора в слив - moveR_90
поворот 2 ротора в экспозицию - moveR_180
поворот 2 ротора в загрузку пробирок - moveR_40
поворот 2 ротора в извлечени пробирок - moveR_60
поворот 2 ротора в установку стекол - moveR_180
поворот 2 ротора в извлесение стекол - moveR_180

### Команды для переключающего клапана 
переключение на og - mvalve_0
продувка og воздухом - mvalve_1

переключение на ea - mvalve_2
продувка ea воздухом - mvalve_3

переключение на gemo - mvalve_4
продувка gemo воздухом - mvalve_5

переключение на alco - mvalve_6
продувка alco воздухом - mvalve_7

переключение на water - mvalve_8
продувка water воздухом - mvalve_9

переключение на chlor - mvalve_10
продувка chlor воздухом - mvalve_11

### Команды для блочного переключающего клапана 
1 зона - bvalve_1
2 зона - bvalve_2
3 зона - bvalve_3
4 зона - bvalve_4

### Команды для одиночных клапанов
1 клапан - kl1
2 клапан - kl2
3 клапан - kl3

### Команды для плунжера
движение - moveppump_N где N задаваемое число

### общие команды 
измерение слива - weight (в ответ w_N где N число в граммах)
проверка сливной емкости - waste (в ответ если полная "full" если нет то "ok")


## Безопасность

- Проверка корректности установки пробирок и стекол
- Журналирование всех операций и ошибок 

- если выбраны зоны 1 и 2 или 1 или 2
-- вращаем только 1 ротор
-- при установке пробирок корректный сигнал с платы приходит 01**(две последних цифры не учитываются)
-- при установке предметных стекол корректный сигнал с платы приходит 10**(две последних цифры не учитываются)
-- при установке промывочной пластины корректный сигнал с платы приходит 11**(две последних цифры не учитываются)

- если выбраны зоны 3 и 4 или 3 или 4
-- вражаем только второй ротор
-- при установке пробирок корректный сигнал с платы приходит **01(две первых цифры не учитываются)
-- при установке предметных стекол корректный сигнал с платы приходит **10(две первых цифры не учитываются)
-- при установке промывочной пластины корректный сигнал с платы приходит **11(две первых цифры не учитываются)

- если выбраны зоны 1,2,3,4 или 1,2,3 или 2,3,4 или 2,3 или 1,3 или 2,4
-- вращаем оба ротора
-- при установке пробирок корректный сигнал с платы приходит 0101
-- при установке предметных стекол корректный сигнал с платы приходит 1010
-- при установке промывочной пластины корректный сигнал с платы приходит 1111

## Алгоритм работы аппарата

### 1. Выбор зон окраски
- При запуске процесса пользователь переходит в окно выбора зон окраски
- Система проверяет уровень сливной емкости
- Роторы активируются в зависимости от выбранных зон

### 2. Подготовка к загрузке образцов
- Система переходит в меню "Загрузить образцы"
- Роторы поворачиваются в положение для установки пробирок
- После получения корректного сигнала отображается кнопка "Начать загрузку образцов"
- При нажатии на кнопку происходит переход в меню загрузки образцов

### 3. Процесс загрузки образцов
- Отображается индикатор прогресса и статус "Происходит загрузка образцов"
- Последовательность действий:
  1. Ротор поворачивается в положение встряхивания образцов
  2. Ротор переходит в положение загрузки образцов
  3. Ротор перемещается в положение извлечения образцов
- После завершения отображается сообщение "Загрузка образцов окончена. Извлеките пробирки"
- При получении сигнала "0000" (корректное извлечение) появляется кнопка "Установить стекла"
- После нажатия на кнопку происходит переход в меню установки стекол

### 4. Установка предметных стекол
- Ротор поворачивается в положение для установки стекол
- При получении корректного сигнала установки стекол появляется кнопка "Начать осаждение и окраску"
- После нажатия на кнопку происходит переход в меню осаждения и окраски

### 5. Обработка сигналов в зависимости от выбранных зон

#### Для зон 1 и 2 (или только 1, или только 2):
- Активируется только первый ротор
- Корректные сигналы:
  - Установка пробирок: 01** (последние две цифры не учитываются)
  - Установка стекол: 10** (последние две цифры не учитываются)
  - Установка промывочной пластины: 11** (последние две цифры не учитываются)

#### Для зон 3 и 4 (или только 3, или только 4):
- Активируется только второй ротор
- Корректные сигналы:
  - Установка пробирок: **01 (первые две цифры не учитываются)
  - Установка стекол: **10 (первые две цифры не учитываются)
  - Установка промывочной пластины: **11 (первые две цифры не учитываются)

#### Для комбинированных зон (1,2,3,4 или 1,2,3 или 2,3,4 или 2,3 или 1,3 или 2,4):
- Активируются оба ротора
- Корректные сигналы:
  - Установка пробирок: 0101
  - Установка стекол: 1010
  - Установка промывочной пластины: 1111

## Окна интерфейса

### Главное меню
- Кнопки:
  - "Начало осаждения и окраски" -> переход в окно выбора зон окраски
  - "Начало промывки" -> переход в меню промывки
  - "Настройки" -> переход в меню настроек

### Выбор зон окраски
- Зона выбора зон:
  - Два столбца: первый для зон 1,2, второй для зон 3,4
- Кнопки:
  - "Подтвердить выбор" -> проверка уровня слива
  - "Перейти к установке пробирок" -> переход в меню загрузки образцов
  - "Вернуться в главное меню"
- Примечание: переход дальше невозможен, если зоны не выбраны

### Меню загрузки образцов
- Отображение статуса установки пробирок
- Кнопки:
  - "Начать загрузку образцов" -> переход в процесс загрузки
  - "Вернуться назад"

### Процесс загрузки образцов
- Индикатор прогресса
- Статус "Происходит загрузка образцов"
- Последовательность действий:
  1. Встряхивание образцов
  2. Загрузка образцов
  3. Извлечение образцов
- Кнопка "Установить стекла" (появляется после получения сигнала "0000")

### Меню установки стекол
- Отображение статуса установки стекол
- Кнопка "Начать осаждение и окраску" (появляется после получения корректного сигнала)
- Кнопка "Вернуться назад"

### Меню осаждения и окраски
- Индикатор прогресса процесса
- Кнопка "Остановить процесс"
- Кнопка "Вернуться в главное меню"

### Настройки
- Зона настроек аппарата:
  - Выбор темы (светлая/темная)
  - Режим работы (эмуляция/UART)
  - Настройки отладочного терминала
    - В режиме эмуляции: отображение и ручной ввод сигналов
  - Настройки UART
- Зона настройки методики:
  - Редактирование "metodology" из toml файла
  - Кнопки:
    - "Сохранить настройки"
    - "Выйти в меню" (с предупреждением при несохраненных изменениях)

### Настройки алгоритма аппарата (запаролено)
- Редактирование блока "algoritm"
- Кнопки:
  - "Сохранить настройки"
  - "Выйти в меню" (с предупреждением при несохраненных изменениях)

### 
