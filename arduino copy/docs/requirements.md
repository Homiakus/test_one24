# Требования к системе управления 5 шаговыми двигателями

## Основные требования

### Аппаратная платформа
- **Arduino Mega 2560** - основная плата управления
- **5 шаговых двигателей** с драйверами step/dir/enable
- **Концевые выключатели** для поиска нуля (NPN и PNP типы)
- **Дополнительные управляющие пины** для периферии

### Библиотека управления двигателями
- **AccelStepper** - основная библиотека (заменена с FastAccelStepper из-за несовместимости с аналоговыми пинами A0, A6, A7)
- **MultiStepper** - планировщик для **одновременного координированного движения** всех двигателей
- **SerialCommand** - для обработки команд через Serial порт

## Функциональные требования

### 1. Координированное движение двигателей
- **Обязательное использование планировщика (MultiStepper)**
- **Все двигатели должны двигаться одновременно**
- **Синхронное достижение целевых позиций**
- **Координированное ускорение и торможение**

### 2. Поиск нуля (хоминг)
- **Двухэтапный алгоритм**:
  1. Движение до концевого выключателя
  2. Откат на заданное расстояние
- **Поддержка NPN и PNP датчиков**
- **Индивидуальные настройки для каждого двигателя**
- **setAutoEnable(false)** - ручное управление включением

### 3. Serial команды управления
- `steppermove pos0 pos1 pos2 pos3 pos4` - координированное движение
- `stepperhome bool0 bool1 bool2 bool3 bool4` - поиск нуля
- `pinon index` / `pinoff index` - управление дополнительными пинами
- `status` - диагностика системы

### 4. Обработка ошибок
- **Таймауты** для предотвращения зависания
- **Проверка состояний** концевых выключателей
- **Валидация параметров** входящих команд
- **Диагностические сообщения**

## Конфигурация пинов

### Назначение двигателей (из config.h)
| Двигатель      | Назначение | Step Pin | Dir Pin | Enable Pin | Home Pin | Тип датчика |
|----------------|------------|----------|---------|------------|----------|-------------|
| Multi (X)      | Основной   | A0       | A1      | 38         | 14       | PNP         |
| Multizone (Y)  | Зона       | A6       | A7      | A2         | 2        | NPN         |
| RRight (Z)     | Правый     | 46       | 48      | A8         | 2        | NPN         |
| E0             | Экструдер0 | 26       | 28      | 24         | 15       | NPN         |
| E1             | Экструдер1 | 36       | 34      | 30         | 15       | NPN         |

### Настройки двигателей
| Двигатель      | Макс.скорость | Ускорение | Скорость хоминга | Шаги/оборот |
|----------------|---------------|-----------|------------------|-------------|
| Multi (X)      | 6000 шаг/сек  | 5000      | 6000 шаг/сек     | 200         |
| Multizone (Y)  | 600 шаг/сек   | 800       | 400 шаг/сек      | 200         |
| RRight (Z)     | 30000 шаг/сек | 2000      | 2000 шаг/сек     | 200         |
| E0             | 2000 шаг/сек  | 2000      | 1000 шаг/сек     | 200         |
| E1             | 2000 шаг/сек  | 2000      | 1000 шаг/сек     | 200         |

### Дополнительные управляющие пины
- Пин 18 (PUMP) - насос
- Пин 8 (KL1) - клапан 1
- Пин 10 (KL2) - клапан 2
- Пин 19 (WASTE) - отходы
- Пины 27, 29, 23, 25 (ROTOR) - вращение
- Пины 42, 40 (HX711) - весы

## Технические требования

### Производительность
- **Размер прошивки**: не более 30% Flash памяти
- **Использование RAM**: не более 50%
- **Скорость Serial**: 115200 бод

### Совместимость
- **Поддержка аналоговых пинов** как цифровых (A0, A6, A7)
- **Различные типы концевых выключателей** (NPN/PNP)
- **Универсальность** - работа с любыми step/dir драйверами

### Архитектурные принципы
- **SOLID** - четкое разделение ответственности
- **KISS** - простота и понятность кода
- **DRY** - избегание дублирования
- **Модульность** - разделение на логические компоненты

## Критически важные особенности

### 1. Планировщик движения (ОБЯЗАТЕЛЬНО!)
```cpp
#include <MultiStepper.h>
MultiStepper steppers;
// Добавление всех двигателей в планировщик
// Координированное движение через runToPosition()
```

### 2. Проблемы с FastAccelStepper
- **НЕ поддерживает аналоговые пины** A0, A6, A7 как step-пины
- **Требует специальные таймерные пины** Arduino Mega
- **Поэтому заменена на AccelStepper**

### 3. Управление enable пинами
- **setAutoEnable(false)** - отключить автоматическое управление
- **Ручное управление** через digitalWrite()
- **Постоянное или временное питание** двигателей

### 4. Типы концевых выключателей
```cpp
// NPN: активное состояние = LOW (заземление)
// PNP: активное состояние = HIGH (питание)
bool readHomeSwitch(int motorIndex) {
    bool switchState = digitalRead(homePins[motorIndex]);
    return endstopTypeNPN[motorIndex] ? (switchState == LOW) : (switchState == HIGH);
}
```

## Ожидаемое поведение

### Команда coordinatedMove
1. **Все двигатели получают целевые позиции одновременно**
2. **MultiStepper рассчитывает траектории**
3. **Синхронное движение с одновременным достижением целей**
4. **Один таймаут для всей группы**

### Команда stepperHome
1. **Последовательный или параллельный хоминг** (настраиваемо)
2. **Двухэтапный алгоритм** для каждого двигателя
3. **Учет типа датчика** (NPN/PNP)
4. **Откат и установка нулевой позиции**

### Обработка ошибок
1. **Таймауты движения** (60 секунд по умолчанию)
2. **Проверка концевых выключателей**
3. **Валидация команд**
4. **Диагностические сообщения**

## Результат
Система должна обеспечивать:
- ✅ **Координированное движение всех 5 двигателей**
- ✅ **Использование планировщика MultiStepper**
- ✅ **Двухэтапный поиск нуля**
- ✅ **Поддержку NPN/PNP датчиков**
- ✅ **Serial интерфейс управления**
- ✅ **Обработку ошибок и таймаутов**
- ✅ **Совместимость с аналоговыми пинами**
- ✅ **Ручное управление enable пинами** 