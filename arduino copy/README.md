# Система управления 5 шаговыми двигателями

Программа для Arduino Mega 2560 с использованием библиотек AccelStepper и MultiStepper для управления до 5 шаговыми двигателями с координированным движением, поиском нуля и Serial интерфейсом.

## Возможности

- **Координированное движение с планировщиком** - синхронное перемещение всех 5 двигателей с использованием MultiStepper
- **Одновременное ускорение и торможение** - все двигатели достигают целевых позиций одновременно
- **Поиск нуля** - двухэтапный алгоритм с концевыми выключателями
- **Serial команды** - полное управление через последовательный порт
- **Индивидуальные настройки** - отдельные параметры для каждого двигателя
- **Поддержка NPN и PNP датчиков** - автоматическое определение типа концевых выключателей
- **Обработка ошибок** - таймауты и проверка состояний
- **Управление дополнительными пинами** - 10 управляющих выходов
- **Совместимость с любыми пинами** - поддержка аналоговых пинов как цифровых
- **Прогресс движения** - мониторинг выполнения команд в реальном времени

## Технические характеристики

- **Платформа**: Arduino Mega 2560
- **Библиотеки**: AccelStepper@1.64 + MultiStepper (координированное движение)
- **Размер прошивки**: 17532 байт (6.9% Flash)
- **Использование RAM**: 2361 байт (28.8%)
- **Бод**: 115200
- **Особенность**: Все двигатели движутся одновременно с планировщиком траекторий

## Конфигурация пинов

### Шаговые двигатели
| Двигатель      | Step Pin | Dir Pin | Enable Pin | Home Pin | Тип датчика |
|----------------|----------|---------|------------|----------|-------------|
| Multi (X)      | A0       | A1      | 38         | 14       | PNP         |
| Multizone (Y)  | A6       | A7      | A2         | 2        | NPN         |
| RRight (Z)     | 46       | 48      | A8         | 2        | NPN         |
| E0             | 26       | 28      | 24         | 15       | NPN         |
| E1             | 36       | 34      | 30         | 15       | NPN         |

### Скорости и ускорения
| Двигатель      | Макс.скорость | Ускорение | Скорость хоминга |
|----------------|---------------|-----------|------------------|
| Multi (X)      | 6000 шаг/сек  | 5000      | 6000 шаг/сек     |
| Multizone (Y)  | 600 шаг/сек   | 800       | 400 шаг/сек      |
| RRight (Z)     | 30000 шаг/сек | 2000      | 2000 шаг/сек     |
| E0             | 2000 шаг/сек  | 2000      | 1000 шаг/сек     |
| E1             | 2000 шаг/сек  | 2000      | 1000 шаг/сек     |

### Дополнительные управляющие пины
- Индекс 0: Пин 18 (PUMP)
- Индекс 1: Пин 8 (KL1)
- Индекс 2: Пин 10 (KL2)
- Индекс 3: Пин 19 (WASTE)
- Индекс 4: Пин 27 (ROTOR)
- Индекс 5: Пин 29 (ROTOR)
- Индекс 6: Пин 23 (ROTOR)
- Индекс 7: Пин 25 (ROTOR)
- Индекс 8: Пин 42 (HX711_SCK)
- Индекс 9: Пин 40 (HX711_DT)

## Установка

1. Установите PlatformIO
2. Склонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd arduino-stepper-system
   ```
3. Скомпилируйте и загрузите:
   ```bash
   pio run --target upload
   ```

## Использование

### Подключение к Serial Monitor
- Откройте Serial Monitor с настройкой 115200 бод
- Программа готова к приему команд

### Команды

#### `steppermove pos0 pos1 pos2 pos3 pos4`
Перемещает двигатели на указанные позиции (в миллиметрах).  
Используйте `*` для пропуска двигателя.

**Примеры:**
```
steppermove 10 20 * 5 15    // Multi, Multizone, *, E0, E1 на позиции 10,20,5,15мм
steppermove 0 0 0 0 0       // Все двигатели в нулевую позицию
steppermove * * 50 * *      // Только RRight (Z) на 50мм
```

#### `stepperhome bool0 bool1 bool2 bool3 bool4`
Выполняет поиск нуля для выбранных двигателей.  
Используйте `1` для поиска нуля, `0` для пропуска.

**Примеры:**
```
stepperhome 1 1 1 1 1       // Поиск нуля для всех двигателей
stepperhome 1 0 0 0 1       // Только для Multi и E1
stepperhome 0 0 0 0 0       // Отмена поиска нуля
```

#### `pinon index` / `pinoff index`
Включает/отключает дополнительный управляющий пин.

**Примеры:**
```
pinon 0                     // Включить насос (пин 18)
pinoff 0                    // Отключить насос
pinon 1                     // Включить клапан KL1 (пин 8)
pinon 2                     // Включить клапан KL2 (пин 10)
```

#### `status`
Показывает текущее состояние системы, позиции двигателей и состояние концевых выключателей.

## Алгоритм поиска нуля

1. **Этап 1**: Двигатель движется до срабатывания концевого выключателя или достижения лимита шагов
2. **Этап 2**: Двигатель отъезжает на заданное расстояние (200 шагов по умолчанию)
3. **Завершение**: Текущая позиция устанавливается как 0

### Поддержка NPN и PNP датчиков
- **NPN датчики**: Активное состояние = LOW (заземление)
- **PNP датчики**: Активное состояние = HIGH (питание)
- Система автоматически определяет тип по конфигурации

## Настройки двигателей

Настройки находятся в файле `src/main.cpp`:

```cpp
// Максимальная скорость (шагов/сек)
const long maxSpeed[NUM_MOTORS] = {6000, 600, 30000, 2000, 2000};

// Ускорение (шагов/сек²)
const long acceleration[NUM_MOTORS] = {5000, 800, 2000, 2000, 2000};

// Скорость хоминга (шагов/сек)
const long homingSpeed[NUM_MOTORS] = {6000, 400, 2000, 1000, 1000};

// Тип датчика (true=NPN, false=PNP)
const bool endstopTypeNPN[NUM_MOTORS] = {false, true, true, true, true};

// Шагов на единицу (шагов/мм)
const long stepsPerUnit[NUM_MOTORS] = {80, 80, 80, 80, 80};
```

## Безопасность

- **Концевые выключатели**: Обязательно подключите концевые выключатели для безопасного поиска нуля
- **Таймауты**: Система автоматически останавливает движение при превышении времени ожидания
- **Проверка состояний**: Движение блокируется во время поиска нуля и наоборот
- **Поддержка разных типов датчиков**: NPN и PNP концевые выключатели

## Диагностика

### Частые проблемы

1. **Двигатель не движется**: Проверьте подключение enable пина
2. **Поиск нуля не работает**: Проверьте подключение концевых выключателей и тип датчика
3. **Неправильное направление**: Измените полярность dir пина
4. **Команды не распознаются**: Проверьте бод Serial порта (115200)

### Команда status
Используйте команду `status` для проверки:
- Состояния включения двигателей
- Текущих позиций
- Состояния концевых выключателей (с указанием типа NPN/PNP)
- Конфигурации пинов для каждого двигателя

### Пример вывода status:
```
=== STEPPER SYSTEM STATUS ===
Motors enabled: NO
Homing active: NO
All motors idle: YES

Motor positions:
Multi(X): 0.00 units (0 steps) - IDLE
Multizone(Y): 0.00 units (0 steps) - IDLE
RRight(Z): 0.00 units (0 steps) - IDLE
E0: 0.00 units (0 steps) - IDLE
E1: 0.00 units (0 steps) - IDLE

Home switches:
Multi(X) (PNP): OPEN
Multizone(Y) (NPN): OPEN
RRight(Z) (NPN): OPEN
E0 (NPN): OPEN
E1 (NPN): OPEN

Pin configuration:
Multi(X) - Step:A0 Dir:A1 Enable:38 Home:14
Multizone(Y) - Step:A6 Dir:A7 Enable:A2 Home:2
RRight(Z) - Step:46 Dir:48 Enable:A8 Home:2
E0 - Step:26 Dir:28 Enable:24 Home:15
E1 - Step:36 Dir:34 Enable:30 Home:15
```

## Разработка

Проект следует принципам:
- **SOLID** - четкое разделение ответственности
- **KISS** - простота и понятность кода
- **DRY** - отсутствие дублирования

Файлы проекта:
- `src/main.cpp` - основной код программы
- `platformio.ini` - конфигурация PlatformIO
- `docs/` - документация проекта

## Лицензия

MIT License 